<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content, viewport-fit=cover">
    <title>Anacleto AI - Camping Rubicone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <style>
        /* --- DEFINIZIONE VARIABILI E TEMI --- */
        :root {
            /* FONT */
            --font-main: 'Open Sans', sans-serif;
            --font-head: 'Roboto Condensed', sans-serif;

            /* =========================================
               TEMA DI DEFAULT (ANACLETO - Dark/Gold)
               ========================================= */
            --bg-body: #1a1a1a;          /* Sfondo pagina intera */
            --bg-chat: #1a1a1a;          /* Sfondo area chat */
            --bg-header-input: #252525;  /* Sfondo Header e Input bar */
            --border-color: #333333;

            --text-main: #f5f5f5;        /* Testo principale */
            --text-header: #FFD54F;      /* Testo Header (Oro) */

            --accent-color: #FFD54F;     /* Colore primario (Oro) */
            --accent-text: #1a1a1a;      /* Testo sopra colore primario */

            --msg-bot-bg: #2d2d2d;       /* Sfondo msg Bot */
            --msg-bot-text: #f0f0f0;     /* Testo msg Bot */

            --msg-user-bg: #FFD54F;      /* Sfondo msg User */
            --msg-user-text: #1a1a1a;    /* Testo msg User */

            --input-bg: #333333;         /* Sfondo campo input */
            --input-text: #ffffff;       /* Testo campo input */
            --placeholder: #888888;

            --scrollbar: #444444;
        }

        /* =========================================
           TEMA PERSONALIZZATO (Corallo & Blu Notte)
           Basta aggiungere class="palette-personalized" al body
           ========================================= */
        body.palette-personalized {
            --bg-body: #D7D7D7;          /* Grigio chiaro */
            --bg-chat: #FFFFFF;          /* Bianco */
            --bg-header-input: #025464;  /* Blu Notte */
            --border-color: #025464;

            --text-main: #273F4F;        /* Blu scuro */
            --text-header: #FFFFFF;      /* Bianco */

            --accent-color: #FE7743;     /* Corallo */
            --accent-text: #FFFFFF;      /* Bianco */

            --msg-bot-bg: #E8F0F5;       /* Azzurrino chiarissimo */
            --msg-bot-text: #273F4F;     /* Blu scuro */

            --msg-user-bg: #FE7743;      /* Corallo */
            --msg-user-text: #FFFFFF;    /* Bianco */

            --input-bg: #FFFFFF;         /* Bianco */
            --input-text: #333333;       /* Scuro */
            --placeholder: #5A7584;

            --scrollbar: #447D9B;
        }

        /* --- RESET E STRUTTURA --- */
        html, body {
            height: 100dvh;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow: hidden;
            overscroll-behavior: none;
            transition: background-color 0.3s, color 0.3s;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            max-width: 100%;
            background-color: var(--bg-chat);
            transition: background-color 0.3s;
        }

        /* --- HEADER --- */
        header {
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            background-color: var(--bg-header-input); /* Variabile dinamica */
            color: var(--text-header);                /* Variabile dinamica */
            text-align: center;
            font-family: var(--font-head);
            font-weight: bold;
            letter-spacing: 1px;
            font-size: 1.1rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- CHAT WINDOW --- */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-chat);
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar) var(--bg-chat);
            -webkit-overflow-scrolling: touch;
        }

        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: var(--bg-chat); }
        #chat-window::-webkit-scrollbar-thumb { background-color: var(--scrollbar); border-radius: 10px; }

        /* --- MESSAGGI --- */
        .message {
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            font-size: 0.95rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background-color: var(--msg-bot-bg);
            color: var(--msg-bot-text);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid var(--border-color);
        }

        .user-message {
            background-color: var(--msg-user-bg);
            color: var(--msg-user-text);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            font-weight: 600;
        }

        /* --- INPUT AREA --- */
        #input-form {
            display: flex;
            padding: 15px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            background-color: var(--bg-header-input);
            border-top: 1px solid var(--border-color);
            gap: 10px;
            flex-shrink: 0;
            transition: background-color 0.3s;
        }

        #user-input {
            flex-grow: 1;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--input-text);
            padding: 12px 15px;
            border-radius: 25px;
            font-family: var(--font-main);
            font-size: 16px;
            outline: none;
            -webkit-appearance: none;
        }

        #user-input::placeholder { color: var(--placeholder); }
        #user-input:focus { border-color: var(--accent-color); }

        #send-button {
            background-color: var(--accent-color);
            color: var(--accent-text);
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        #send-button:hover { opacity: 0.9; }
        #send-button:active { transform: scale(0.95); }

        .typing-indicator {
            font-style: italic;
            color: var(--placeholder);
            font-size: 0.8rem;
        }

    </style>
</head>
<body id="chat-body">
    <div id="chat-container">
        <header>Camping Rubicone</header>

        <div id="chat-window">
            <div class="message bot-message">
                Ciao! Sono Anacleto il tuo assistente digitale personale. Come posso esserti utile oggi?
            </div>
        </div>

        <form id="input-form">
            <input type="text" id="user-input" placeholder="Scrivi un messaggio..." autocomplete="off">
            <button type="submit" id="send-button">➤</button>
        </form>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        // Cambia in "personalized" per testare l'altra palette
        const CURRENT_PALETTE_NAME = "default";

        const API_URL = 'https://script.google.com/macros/s/AKfycbwYqzFN2cMmMkP3ikWEuizC_W5sgTpUueqja0E8kpzAQ4wv_7ZBZn5eMM9fMNyl4S0/exec';

        const chatBody = document.getElementById('chat-body');
        const chatWindow = document.getElementById('chat-window');
        const inputForm = document.getElementById('input-form');
        const userInput = document.getElementById('user-input');
        const conversation_id = "session_" + Date.now() + Math.random().toString(36).substring(2, 9);

        // --- FUNZIONE PER APPLICARE LA PALETTE ---
        function applyPalette(paletteName) {
            chatBody.className = '';
            if (paletteName === "personalized") {
                chatBody.classList.add('palette-personalized');
            }
        }

        // Applicazione iniziale
        applyPalette(CURRENT_PALETTE_NAME);

        // --- GESTIONE INVIO MESSAGGI ---
        inputForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessageText = userInput.value.trim();

            if (userMessageText) {
                // 1. Mostra messaggio utente
                displayMessage(userMessageText, 'user');
                userInput.value = '';

                // 2. Loading
                const loadingId = 'loading-' + Date.now();
                const loadingDiv = document.createElement('div');
                loadingDiv.id = loadingId;
                loadingDiv.classList.add('message', 'bot-message');
                loadingDiv.innerHTML = '<span class="typing-indicator">Sta scrivendo...</span>';
                chatWindow.appendChild(loadingDiv);
                scrollToBottom();

                try {
                    // 3. Chiamata API
                    const responseText = await fetchApiResponse(userMessageText);
                    document.getElementById(loadingId).remove();
                    displayMessage(responseText, 'bot');
                } catch (error) {
                    if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                    displayMessage('Errore di connessione. Riprova più tardi.', 'bot');
                }
            }
        });

        function displayMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            messageElement.innerText = text;
            chatWindow.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function fetchApiResponse(prompt) {
            const params = new URLSearchParams();
            params.append('conversation_id', conversation_id);
            params.append('prompt', prompt);
            params.append('agent_id', "camping-rubicone");

            const response = await fetch(`${API_URL}?${params.toString()}`);
            if (!response.ok) throw new Error('Network response error');
            const data = await response.text();
            return data || "Nessuna risposta ricevuta.";
        }
    </script>
</body>
</html>
